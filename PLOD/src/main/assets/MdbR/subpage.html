<!-- 这个是网页版 -->
<!DOCTYPE html>
<html>
<meta name='viewport' content='initial-scale=1,user-scalable=yes' class="_PDict">
<head>
<style>
	mark {background: yellow; }
	mark.current {
		background: orange;
		box-shadow: inset 0px 0px 0px .5px #ff0000;
	}
	.highlight { background-color: yellow; }
	img{max-width:100%;}
	html, body {
		-moz-user-select:text;
		-webkit-user-select:text;
		-ms-user-select:text;
		-khtml-user-select:text;
		user-select:text;
		min-height: unset!important;
	}
</style>

<script>
var debug = function(a,b,c,d,e){var t=[a,b,c,d,e];for(var i=5;i>=0;i--){if(t[i]===undefined)t[i]='';else break}console.log("%c 子页面 ","color:#333!important;background:#b0f7ce;",t[0],t[1],t[2],t[3],t[4])};
(function(){
debug("frameElement::", frameElement);
function ge(e){return document.getElementById(e)};
if(frameElement) {
	window._merge={};
	window.edEtJts=function(a, b, c){
		if(!_merge[b]) {
			(b.d?document:window).addEventListener(a, b, c);
			_merge[b] = 1;
		}
	};
}
window.shzh=0;
var remarked=false;
window.addEventListener('load',wrappedOnLoadFunc,false);
window.addEventListener('click',wrappedClickFunc);
window.addEventListener('mousedown',wrappedDown);
window.addEventListener('touchstart',wrappedDown);
//window.addEventListener('scroll',wrappedScroll,true);

// function wrappedScroll(e){
// 	debug(e);
// 	document.body.scrollTop=0;
// 	e.preventDefault();
// 	e.stopPropagation();
// }
function wrappedOnLoadFunc(){
	debug('wrappedOnLoadFunc');
	window.addEventListener('click',parent.window.tpshc); //wtf??
	// //document.body.style.fontSize=35+'px';
	// highlight(null);
	// //debug('frameAt !! '+frameAt);
	// if(_onloadchecks && _onloadchecks.length)
	// for(var i=0;i<_onloadchecks.length;i++){
	// 	_onloadchecks[i]();
	// }
	//debug("wrappedOnLoadFunc::", frameElement.tag, frameElement.u, location.href);
	var fe=frameElement, pw=parent.window;
	if(pw.processPage) pw.processPage(fe);
	if(fe) {
		debug('mdpage loaded', fe.dictInfo.name, 'tpshc!=null:'+parent.tpshc!=null);
		var inf=fe.dictInfo;
		if(pw) {
			// window.addEventListener('click',pw.tpshc);
			for(var i=0,j;j=pw._merge[i++];) {
				edEtJts(j[0], j[1], j[2])
			}
			// if(pw.paddingLeft) {
			// 	document.body.style.paddingLeft = pw.paddingLeft;
			// }
		}
		if(!fe.scrollExpand) {
			if(inf.lastX || inf.lastY)
				document.documentElement.scrollTo(inf.lastX, inf.lastY);
		}
		if(fe.u) {
			if(fe.u.startsWith(location.href)) {
				location.href=fe.u;
			}
			fe.u=0;
		}
		if(pw.bOnceHighlighted) {
			console.log('子页面高亮开始!!!');
			pw.MarkFrame(fe);
		}
		//debug('needs img loader', inf.img, inf.name);
		if(pw.app && inf.img) {
			pw.LoadIMG(inf);
		}
	} else if(pw.app){
		window.shzh=app.rcsp(sid.get());
	}
	if(!remarked) {
		if(fe) {
			restoreMarks(pw); 
		} else if(app){
			loadJs('/MdbR/annot.js', function(){restoreMarks(window)})
		}
		remarked = true;
	}
	//todo 处理背景色？
}

function loadJs(url,callback){
	var e=document.createElement('script');
	e.type="text/javascript";
	e.onload=callback;
	e.src=url;
	document.body.appendChild(e);
}

function restoreMarks(pw){
	var url = ''+location.href, idx = url.indexOf('_'), multi=url.indexOf('_', idx+1) > 0;
	var t = app.remarkByUrl(sid.get(), url);
	debug('remarkByUrl???', url, t);
	if(multi) {
		t = t.split('\t'); // \n\n\n
		var frames = document.getElementsByClassName('_PDict_body'), map=[];
	 	for(var i=0,f;f=frames[i++];) {
			map[f.getAttribute('pd_pos')] = f;
		}
		debug('remarkByUrl::multi::', t, 'map=',map);
	 	for(var i=0,f,n;n=t[i];i+=2) {
			f = map[t[i+1]];
			if(f) {
				debug('remark=', t[i+1], f);
				remark(n, f, document, pw); 
			}
		}
	} else {
		remark(t, document.body, document, pw); 
	}
}

function remark(t, rootNode, doc, w){
    w.RestoreMarks(t, rootNode, doc);
}

window.markPage = function(tcn) {
	var s = window.getSelection();
	if(s && !s.isCollapsed) {
		var wh = whereSelection();
		MakeMark(tcn, wh[2], document, wh[0], wh[1])
	}
}

window.expUrl = function() {
	return url.substring(url.lastIndexOf('/',idx));
}

window.whereSelection = function(){
	var url = ''+location.href, idx = url.indexOf('_'), multi=url.indexOf('_', idx+1) > 0;
	var pos, did = did = url.substring(url.lastIndexOf('/',idx)+1, idx), rootNode=document.body;
	if(multi) {
		var n = getSelection().getRangeAt(0).startContainer;
		while(n=n.parentNode) {
			if(n.classList.contains('_PDict_body')) {
				pos = parseInt(n.getAttribute('pd_pos'))
				rootNode = n;
				break;
			}
		}
	} else {
		//todo handle ? parms
		pos = window.pos;
		if(pos==undefined) pos = parent.window.decodePosid(url.substring(idx+1));
	}

	debug('whereSelection::', pos, did, url.substring(idx+1));
	return [pos, did, rootNode];

}

window.loadVI = function(pos){
	//111
	debug('hi !! loadVI/'+pos);
	var req=new XMLHttpRequest();
	req.open('POST','VI/'+pos);
	req.responseType='text';
	req.onreadystatechange=function(e) {
		if(req.readyState == 4 && req.status==200) {
			debug(req.responseText);
			var vc = JSON.parse(req.responseText);
			if(vc.JS){
				eval(vc.JS)
			}
		}
	};
	req.send(null);
}
var _onloadchecks;
var frameAt;
var audio;
var regHttp=new RegExp("^https?://");
var regEntry=new RegExp("^entry://");
var regPdf=new RegExp("^pdf://");
var regSound=new RegExp("^sound://");
var nxtEntry;
var stopLnk;

function hiPlaySound(e){
	var cur=e.ur1?e:e.srcElement;
	//debug("hijacked sound playing : "+cur.ur1);
	if(audio)
		audio.pause();
	else
		audio = new Audio();
	audio.src = cur.ur1;
	audio.play();
}

function popupEntry(e){
	var t;
	for(var i=0;i<10 && (t=e.path[i]);i++)
		if(t.href!==undefined)
			break;
	if(window.app && app.shouldPopupEntry()) {
		app.popupEntry(sid.get(), t.href);
		stopLnk = 1;
		return true;
	}
	return false;
}

function getId(){
	return frameElement?frameElement.dictInfo.id:''
}
function entryPop(t){
	if(window.app && app.entryPopup(sid.get(), getId())) {
		if(t.onclick!==popupEntry) {
			t.rawClick=t.onclick;
			t.onclick=popupEntry;
		}
	} else if(t.onclick==popupEntry) {
		t.onclick=t.rawClick;
	}
}

function wrappedDown(e){
	//debug(e);
	var t;
	for(var i=0;i<10 && (t=e.path[i]);i++)
		if(t.href!==undefined)
			break;
	if(!parent.window._touchtarget_lck && e.touches && e.touches.length==1){
		parent.window._touchtarget = e.touches[0].target;
		parent.window.subw = window;
	}
	if(frameElement && ((e.button||0)==0)) {
		parent.window.tFrame(frameElement.dictInfo);
	}
	stopLnk = 0;
	if(t && t.href) { //  && (e.button==1||e.button==0)
		stopLnk = 1;
		debug("01! found link : "+t.href+" : "+regSound.test(t.href));
		var getRawLink=t.href;
		var patt1 = /\/base\/[0-9]*\/(#.*)/;
		var m = getRawLink.match(patt1);
		if(m && m[0].length>0){
			debug(m[1]);
			getRawLink=m[1];
			debug(window.location.href);
			t.href=window.location.href+getRawLink;
			return false;
		}
		if(regEntry.test(t.href)) {
			var ent=t.href.substring(8)
			t.ent=ent;
			t.href="entry/"+ent;
			debug("regEntry", ent, t.href);
			nxtEntry=t;
			entryPop(t);
		} 
		else if(t.ent) {
			nxtEntry=t;
			entryPop(t);
		}
		else if(regSound.test(t.href)) {/*拦截 sound 连接*/
			var link=/* "sound/"+ */t.href.substring(8);
			t.href=link;
			if(t.onclick==undefined){
				//debug("1! found internal sound link : "+cur.href);
				t.ur1=t.href;
				t.removeAttribute("href");
				t.onclick=hiPlaySound;
				hiPlaySound(t)
				return false;
			}
		}
		else if(parent.app && regHttp.test(t.href)){
			//debug('拦截 http');
			stopLnk = t.href;
			return true;
		}
		else if(parent.app && regPdf.test(t.href)){/*拦截 pdf*/
			parent.app.handlePdfLink(t.href);
			return false;
		}
		stopLnk = 0;
		//debug('连接通行！');
		return true;
	}
}

function JumpUrl(nxt){
	var ent=nxt.ent;
	var h=ent.indexOf('#');
	debug("entry::", nxt.href, location.href);
	if(h>0) {
		parent.window.JumpUrlTag(frameElement, ent.slice(h+1), nxt.href, nxt);
		//ent=ent.slice(0,h);
	} else {
		parent.window.JumpUrlFrame(frameElement);
	}
}


function wrappedClickFunc(e){
	if(parent.app && stopLnk) {
		if(typeof stopLnk==='string')
			parent.app.handleWebLink(getId(), stopLnk);
		e.preventDefault();
		stopLnk = 0;
		return;
	}
	if(nxtEntry) {
		if(!frameElement || frameElement.dictInfo.scrollExpand) JumpUrl(nxtEntry);
		nxtEntry=0;
	}
}

/*!!!高亮开始*/

})()
</script>

<base href='/base//'/>
<base target="_self" />